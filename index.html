<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>聊天系统</title>
    <link rel="stylesheet" href="./static/layui/css/layui.css" media="all">
</head>

<body>

    <div class="layui-container" id="login-panel">
        <header class="h1">登录</header>
        <div class="layui-input-inline">
            <input type="text" name="account" required lay-verify="required" placeholder="用户名" autocomplete="off"
                class="layui-input" id="account_input">
        </div>
        <div class="layui-input-inline">
            <input type="password" name="password" required lay-verify="required" placeholder="密码" autocomplete="off"
                class="layui-input" id="password_input">
        </div>
        <div class="layui-input-inline">
            <button class="layui-btn" id="login_btn">登录</button>
        </div>
        <hr />
    </div>

    <div id="find-panel">
        <div class="layui-form-item">
            <label class="layui-form-label">请输入</label>
            <div class="layui-input-block">
                <input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入昵称、账号或id"
                    class="layui-input" id="find_input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="submit" class="layui-btn" lay-submit="" lay-filter="demo1" id="add_btn">添加好友</button>
            </div>
        </div>
    </div>

    <script src="./static/layui/layui.js"></script>
    <script src="./static/js/jquery.min.js?v=2.1.4"></script>
    <script src="./static/js/ws-client.js"></script>
    <script>
        window.onunload = function (event) {
            console.log('close window');
            ws.disconnect();
        }

        function showDiv(id, visible) {
            let traget = document.getElementById(id);
            if (visible) {
                traget.style.display = "block";
            } else {
                traget.style.display = "none";
            }
        };

        // 一开始隐藏登录，socket连接成功了才显示出来
        showDiv("login-panel", true);
        showDiv("find-panel", false);

        // 我的信息
        let myData = null;
        let tmpLayim = null;
        let ws = null;
        let account = "";
        let password = "";

        // 添加登录按钮响应
        document.getElementById("login_btn").addEventListener("click", function () {
            // 获取账号密码
            account = document.getElementById("account_input").value;
            password = document.getElementById("password_input").value;

            console.log("click on login, account = " + account + ", password = " + password);

            let address = "ws://127.0.0.1:41001";
            let socket = new WebSocket(address);
            ws = new WSClient();
            ws.connectSocket(address, socket, function () {
                console.log("call open callback");
                // 发送一个握手消息
                let loginData = {
                    serverType: 'client'
                };
                ws.request("login-req", loginData, (code, resp) => {
                    console.log('client register to login server suss');
                    console.log(resp);
                    onSocketConnected();
                });
            });

            // 好友通知
            ws.on("20001", (data) => {
                console.log("add friend notify");
                console.log(data)
                layer.msg(data.username + "添加你为好友");

                //myData.friendList.push(data);
                // 将好友追加到主面板
                if (tmpLayim) {
                    tmpLayim.addList({
                        type: "friend",
                        username: data.username,
                        avatar: data.avatar,
                        groupid: 1, //所在的分组id
                        id: data.id, //好友ID
                        sign: data.sign //好友签名
                    });
                }
            });
        });

        // 添加好友响应
        document.getElementById("add_btn").addEventListener("click", function () {
            let value = document.getElementById("find_input").value;

            console.log("click on find, account = " + value);

            // 发送添加好友请求
            let reqData = {
                myId: myData.mine.id, // 自己的id
                targetId: value // 目标的id
            }
            ws.request("10006", reqData, (code, data) => {
                console.log("add friend resp, code = " + code);
                console.log(data);
                if (code == 1) {
                    //myData.friendList.push(data);
                    layer.msg("添加好友成功");
                    // 将好友追加到主面板
                    if (tmpLayim) {
                        tmpLayim.addList({
                            type: "friend",
                            username: data.username,
                            avatar: data.avatar,
                            groupid: 1, //所在的分组id
                            id: data.id, //好友ID
                            sign: data.sign //好友签名
                        });
                    }
                } else {
                    // 失败
                    layer.msg("添加好友失败");
                }
            });
        });

        // socket连接成功回调
        onSocketConnected = function () {
            console.log('onSocketConnected');

            // 发送登录请求
            let reqData = {
                account: account,
                pwd: password
            }
            ws.request("10001", reqData, (code, data) => {
                console.log("login resp, code = " + code);
                console.log(data.friendList);
                if (code == 1) {
                    // 登录成功
                    myData = data;
                    onLoginSuss();
                } else {
                    // 失败
                    onLoginFailed();
                }
            });
        };

        // 登录成功回调
        onLoginSuss = function () {
            // 隐藏登录面板
            showDiv("login-panel", false);
            showDiv("find-panel", true);
            showChatPanel();
        };

        onLoginFailed = function () {

        };

        // 显示登录界面
        showLoginPanel = function () {
            showDiv("login-panel", true);
        };

        // 显示聊天界面
        showChatPanel = function () {
            layui.use('layim', function (layim) {
                //先来个客服模式压压精
                console.log("mydata =")
                console.log(myData)

                tmpLayim = layim;
                layim.config({
                    init: {
                        //我的信息
                        mine: {
                            "username": myData.mine.username, //我的昵称
                            "id": myData.mine.id, //我的ID
                            "status": "online", //在线状态 online：在线、hide：隐身
                            "sign": myData.mine.sign, //我的签名
                            "avatar": myData.mine.avatar, //我的头像
                        },
                        friend: [{
                            groupname: "我的好友",
                            id: 1,
                            list: myData.friendList
                        }],
                        group: [],
                    },

                    //上传图片接口（返回的数据格式见下文），若不开启图片上传，剔除该项即可
                    uploadImage: {
                        url: 'http://www.tap2joy.com/upload.php', //接口地址
                        type: 'post' //默认post
                    },

                    msgbox: './msgbox.html', //消息盒子页面地址，若不开启，剔除该项即可
                    find: './find.html' //发现页面地址，若不开启，剔除该项即可
                });

                //监听签名修改
                layim.on('sign', function (value) {
                    console.log("change sign " + value);

                    // 向服务器发送修改请求
                    let reqData = {
                        id: myData.mine.id,
                        sign: value
                    }
                    ws.request("10003", reqData, (code, data) => {
                        console.log("modify sign resp, code = " + code);
                        console.log(data);
                        if (code == 1) {
                            // 登录成功
                            layer.msg("签名修改成功");
                        } else {
                            // 失败
                            layer.msg("签名修改失败");
                        }
                    });
                });
            });
        };
    </script>
</body>

</html>