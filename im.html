<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>聊天系统</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css" media="all">
</head>

<body>

    <div class="layui-container" id="login-panel">
        <header class="h1">登录</header>
        <div class="layui-input-inline">
            <input type="text" name="account" required lay-verify="required" placeholder="用户名" autocomplete="off"
                class="layui-input" id="account_input">
        </div>
        <div class="layui-input-inline">
            <input type="password" name="password" required lay-verify="required" placeholder="密码" autocomplete="off"
                class="layui-input" id="password_input">
        </div>
        <div class="layui-input-inline">
            <button class="layui-btn" id="login_btn">登录</button>
        </div>
        <hr />
    </div>

    <script src="/static/layui/layui.js"></script>
    <script src="/static/js/jquery.min.js?v=2.1.4"></script>
    <script src="/static/js/ws-client.js"></script>
    <script>
        function showDiv(id, visible) {
            let traget = document.getElementById(id);
            if (visible) {
                traget.style.display = "block";
            } else {
                traget.style.display = "none";
            }
        };

        // 一开始隐藏登录，socket连接成功了才显示出来
        showDiv("login-panel", false);

        // 我的信息
        let myData = null;

        // 添加登录按钮响应
        document.getElementById("login_btn").addEventListener("click", function () {
            // 获取账号密码
            let account = document.getElementById("account_input").value;
            let password = document.getElementById("password_input").value;

            console.log("click on login, account = " + account + ", password = " + password);

            // 发送登录请求
            let reqData = {
                account: account,
                pwd: password
            }
            ws.request("10001", reqData, (code, data) => {
                console.log("login resp, code = " + code);
                console.log(data);
                if (code == 1) {
                    // 登录成功
                    myData = data;
                    onLoginSuss();
                } else {
                    // 失败
                    onLoginFailed();
                }
            });
        });

        let address = "ws://127.0.0.1:41001";
        let socket = new WebSocket(address);
        let ws = new WSClient();
        ws.connectSocket(address, socket, function () {
            console.log("call open callback");
            // 发送一个握手消息
            let loginData = {
                serverType: 'client'
            };
            ws.request("login-req", loginData, (code, resp) => {
                console.log('client register to login server suss');
                console.log(resp);
                onSocketConnected();
            });
        });

        // socket连接成功回调
        onSocketConnected = function () {
            console.log('onSocketConnected');

            showLoginPanel();
        };

        // 登录成功回调
        onLoginSuss = function () {
            // 隐藏登录面板
            showDiv("login-panel", false);
            showChatPanel();
        };

        onLoginFailed = function () {

        };

        // 显示登录界面
        showLoginPanel = function () {
            showDiv("login-panel", true);
        };

        // 显示聊天界面
        showChatPanel = function () {
            layui.use('layim', function (layim) {
                //先来个客服模式压压精
                console.log("mydata =")
                console.log(myData)
                layim.config({
                    init: {
                        //我的信息
                        mine: {
                            "username": myData.username, //我的昵称
                            "id": myData.id, //我的ID
                            "status": "online", //在线状态 online：在线、hide：隐身
                            "sign": myData.sign, //我的签名
                            "avatar": myData.avatar, //我的头像
                        },
                        friend: [],
                        group: [],
                    },

                    //上传图片接口（返回的数据格式见下文），若不开启图片上传，剔除该项即可
                    uploadImage: {
                        url: 'http://www.tap2joy.com/upload.php', //接口地址
                        type: 'post' //默认post
                    }
                });

                //监听签名修改
                layim.on('sign', function (value) {
                    console.log("change sign " + value);

                    // 向服务器发送修改请求
                    let reqData = {
                        id: myData.id,
                        sign: value
                    }
                    ws.request("10003", reqData, (code, data) => {
                        console.log("modify sign resp, code = " + code);
                        console.log(data);
                        if (code == 1) {
                            // 登录成功
                            layer.msg("签名修改成功");
                        } else {
                            // 失败
                            layer.msg("签名修改失败");
                        }
                    });
                });
            });
        };
    </script>
</body>

</html>